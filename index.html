<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuroBand – StressSense PWA (Vanilla JS)</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#7c3aed">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --violet:#7c3aed; --violet-dark:#4c1d95; --bg:#0a0218; --panel: rgba(26,15,48,0.95);} 
    body { background: var(--bg); color: #e2e8f0; }
    .card { background: var(--panel); border: 1px solid var(--violet-dark); border-radius: 1rem; color:#f3e8ff; }
    .pill { border-radius: 9999px; }
    header, footer { background: var(--bg); }
    dialog.card { color:#f3e8ff; }
    dialog input, dialog select, dialog textarea { background:#1e1b4b; color:#f3e8ff; }
    dialog label, dialog legend { color:#f3e8ff; }
    input[type="range"]::-webkit-slider-thumb { background: var(--violet); }
    input[type="range"]::-webkit-slider-runnable-track { background: #3b0764; }
    input[type="range"]::-moz-range-thumb { background: var(--violet); }
    input[type="range"]::-moz-range-track { background: #3b0764; }
    a.button, button { transition: filter .15s ease; }
    a.button:hover, button:hover { filter: brightness(1.08); }
    table thead th{ color:#c4b5fd; font-weight:600; }
    table tbody td{ border-top:1px solid rgba(124,58,237,.25); }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-10 backdrop-blur border-b border-violet-900">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div id="status-dot" class="w-3 h-3 rounded-full bg-violet-500"></div>
      <h1 class="text-xl font-semibold text-violet-300">NeuroBand – StressSense</h1>
      <!-- stary napis „Spokojnie” zostawiamy, ale niech nie konkuruje z banerem -->
      <span id="status-text" class="ml-auto text-sm opacity-60">Spokojnie</span>
      <button id="install-btn" class="ml-3 hidden px-3 py-1 text-sm pill bg-violet-600">Zainstaluj PWA</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- [5] Pastelowy baner statusu w widocznym miejscu -->
    <section>
      <div id="stress-banner" class="mx-auto max-w-4xl rounded-2xl px-4 py-3 text-center shadow-lg bg-green-200 text-green-950">
        <div class="text-xs uppercase tracking-wide opacity-80">Stan</div>
        <div id="stress-label" class="text-2xl font-bold">Spokojnie</div>
        <div id="stress-sub" class="text-sm mt-1 opacity-80">Oddychaj miarowo</div>
      </div>
    </section>

    <section class="flex flex-wrap gap-3 items-center">
      <!-- [4] Usunięto „(BLE)” -->
      <button id="connect-btn" class="px-4 py-2 pill bg-violet-600">Połącz z NeuroBand</button>
      <button id="stop-btn" class="px-4 py-2 pill bg-slate-700">Zatrzymaj</button>
      <button id="demo-btn" class="px-4 py-2 pill bg-slate-800">Demo (mock)</button>
      <button id="export-btn" class="px-4 py-2 pill bg-slate-800">Eksport CSV</button>
      <button id="open-survey" class="px-3 py-1 pill bg-violet-600">Ankieta</button>
    </section>

    <section id="error-banner" class="hidden card p-3 text-sm">
      <div class="text-violet-300">Nie udało się połączyć z NeuroBand. Sprawdź zasilanie/zgody BLE. <b>Demo</b> uruchom ręcznie przyciskiem powyżej.</div>
    </section>

    <!-- Charts: HR, GSR, Temp -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card p-4"><div class="flex items-baseline justify-between mb-2"><h3 class="text-base">Tętno</h3><div id="hr-value" class="text-2xl font-semibold">–</div></div><canvas id="hr-chart" height="140"></canvas></div>
      <div class="card p-4"><div class="flex items-baseline justify-between mb-2"><h3 class="text-base">GSR (µS)</h3><div id="gsr-value" class="text-2xl font-semibold">–</div></div><canvas id="gsr-chart" height="140"></canvas></div>
      <div class="card p-4"><div class="flex items-baseline justify-between mb-2"><h3 class="text-base">Temperatura</h3><div id="temp-value" class="text-2xl font-semibold">–</div></div><canvas id="temp-chart" height="140"></canvas></div>
    </section>

    <!-- Interpretation + SI -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold mb-1">Interpretacja</h3>
          <p class="text-sm opacity-90">Fioletowy – normalnie, czerwony – wysoki stres. Progi (dynamiczne): HR Δ≥<span id="dyn-dhr">12</span> bpm; GSR ≥ <span id="dyn-gsr">+25%</span> baseline lub SCR ≥ <span id="dyn-scr">2</span>; Temp informacyjnie (°C).</p>
        </div>
        <div class="text-right">
          <div class="text-xs opacity-70">Wskaźnik stresu (SI)</div>
          <div id="si-value" class="text-3xl font-bold">0.00</div>
          <div id="si-cat" class="text-xs opacity-80">Niski</div>
        </div>
      </div>
    </section>

    <!-- [3] Działające ćwiczenia oddechowe -->
    <section id="relax" class="card p-4">
      <h3 class="text-lg font-semibold mb-3">Ćwiczenia oddechowe</h3>
      <div class="space-y-4">
        <div class="flex gap-3 flex-wrap">
          <button id="start-box" class="px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700">Box 4–4–4–4</button>
          <button id="start-478" class="px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700">Metoda 4–7–8</button>
          <button id="stop-breath" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-800">Stop</button>
        </div>
        <div class="flex items-center gap-4">
          <div id="breath-ball" class="w-28 h-28 rounded-full bg-violet-400 transition-all duration-1000"></div>
          <div class="text-lg" id="breath-cue">Kliknij, aby rozpocząć.</div>
        </div>
        <p class="text-xs text-violet-200">Wskazówka: oddychaj przeponą; jeśli czujesz zawroty głowy — przerwij.</p>
      </div>
    </section>

    <!-- Tabela odczytów -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Tabela odczytów (ostatnie 60 s)</h3>
        <div class="text-xs opacity-70">Czas, HR (bpm), GSR (µS), Temp (°C)</div>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left">
              <th class="py-1 pr-2">Czas</th>
              <th class="py-1 pr-2">HR (bpm)</th>
              <th class="py-1 pr-2">GSR (µS)</th>
              <th class="py-1 pr-2">Temp (°C)</th>
            </tr>
          </thead>
          <tbody id="readings-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Historia & preferencje -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4"><h3 class="text-lg font-semibold mb-2">Historia (ostatnie 14 dni)</h3><div id="history-list" class="space-y-2 text-sm"></div></div>
      <div class="card p-4">
        <h3 class="text-lg font-semibold mb-2">Preferencje i VAS</h3>
        <div class="flex items-center gap-4 text-sm">
          <div>Tryb: <span id="pref-mode">kategorie</span></div>
          <div>Czułość: <span id="pref-alert">silny</span></div>
          <label class="ml-auto text-xs">VAS teraz (0–10)
            <input id="vas-cur" type="range" min="0" max="10" value="3" class="w-40">
          </label>
        </div>
      </div>
    </section>
  </main>

  <!-- Survey dialog -->
  <dialog id="survey-dialog" class="card p-0 w-[48rem] max-w-[98vw]">
    <form id="survey-form" class="contents">
      <div class="p-4 border-b border-violet-900 text-lg font-semibold flex items-center justify-between">
        <span>Ankieta kalibracyjna</span>
        <button id="survey-x" type="button" aria-label="Zamknij" class="p-1 rounded hover:bg-violet-900/40">✕</button>
      </div>
      <div class="p-4 space-y-6 text-sm">
        <!-- Sekcja 1: Dane ogólne -->
        <section class="space-y-3">
          <h4 class="font-semibold text-base">Sekcja 1. Dane ogólne</h4>
          <div class="grid md:grid-cols-2 gap-3">
            <label>Wiek
              <input name="age" type="number" min="12" max="99" required class="mt-1 w-full rounded p-2"/>
            </label>
            <fieldset>
              <legend class="mb-1">Płeć biologiczna</legend>
              <div class="flex gap-4 items-center">
                <label class="flex items-center gap-2"><input type="radio" name="sex" value="F" required> Kobieta</label>
                <label class="flex items-center gap-2"><input type="radio" name="sex" value="M" required> Mężczyzna</label>
              </div>
            </fieldset>
            <fieldset class="md:col-span-2">
              <legend class="mb-1">Aktywność (≥30 min/tydz.)</legend>
              <div class="grid grid-cols-4 gap-2">
                <label class="flex items-center gap-2"><input type="radio" name="activity_freq" value="0" required> 0</label>
                <label class="flex items-center gap-2"><input type="radio" name="activity_freq" value="1-2" required> 1–2</label>
                <label class="flex items-center gap-2"><input type="radio" name="activity_freq" value="3-4" required> 3–4</label>
                <label class="flex items-center gap-2"><input type="radio" name="activity_freq" value="5+" required> 5+</label>
              </div>
            </fieldset>

            <!-- [1] WIELOKROTNY wybór chorób serca -->
            <fieldset class="md:col-span-2">
              <legend class="mb-1">Choroby serca (możesz wybrać kilka)</legend>
              <div class="grid md:grid-cols-2 gap-2">
                <label class="flex items-center gap-2"><input type="checkbox" name="heart" value="nyha12"> Niewydolność (NYHA I–II)</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="heart" value="svt"> Arytmie nadkomorowe stabilne</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="heart" value="sinus"> Tachykardia zatokowa przewlekła</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="heart" value="ihd"> Choroba niedokrwienna stabilna</label>
              </div>
              <p class="text-xs opacity-70 mt-1">Pozostaw puste, jeśli nie dotyczy.</p>
            </fieldset>

            <label class="flex items-center gap-2 md:col-span-2"><input type="checkbox" name="hypertension" value="yes"> Nadciśnienie</label>
            <fieldset class="md:col-span-2">
              <legend class="mb-1">Choroba skóry (jedna opcja)</legend>
              <div class="grid md:grid-cols-2 gap-2">
                <label class="flex items-center gap-2"><input type="radio" name="skin" value="none" required> Brak</label>
                <label class="flex items-center gap-2"><input type="radio" name="skin" value="eczema"> Egzema/AZS aktywne</label>
                <label class="flex items-center gap-2"><input type="radio" name="skin" value="psoriasis"> Łuszczyca dłoniowa</label>
                <label class="flex items-center gap-2"><input type="radio" name="skin" value="dry"> Silna suchość skóry</label>
              </div>
            </fieldset>
            <fieldset class="md:col-span-2">
              <legend class="mb-1">Leki (jedna opcja)</legend>
              <div class="grid grid-cols-3 gap-2">
                <label class="flex items-center gap-2"><input type="radio" name="drug" value="none" required> Brak</label>
                <label class="flex items-center gap-2"><input type="radio" name="drug" value="beta"> Beta-blokery</label>
                <label class="flex items-center gap-2"><input type="radio" name="drug" value="anxio"> Leki przeciwlękowe</label>
              </div>
            </fieldset>
          </div>
        </section>

        <!-- [2] Zmieniony tytuł sekcji 2 -->
        <section class="space-y-3">
          <h4 class="font-semibold text-base">Sekcja 2. Twoje typowe reakcje na stres</h4>
          <div class="grid md:grid-cols-2 gap-2">
            <label class="flex items-center gap-2"><input type="checkbox" name="stress_body" value="hr"> Szybsze bicie serca</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="stress_body" value="sweat"> Pocenie się dłoni</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="stress_body" value="breath"> Problemy z oddechem</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="stress_body" value="tremor"> Drżenie mięśni lub rąk</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="stress_body" value="focus"> Trudność w koncentracji</label>
          </div>
        </section>

        <!-- Sekcja 3: Preferencje -->
        <section class="space-y-3">
          <h4 class="font-semibold text-base">Sekcja 3. Preferencje</h4>
          <fieldset>
            <legend class="mb-1">Powiadomienia</legend>
            <label class="flex items-center gap-2"><input type="radio" name="pref_alert" value="all" required> O każdym wzroście (lekki i silny)</label>
            <label class="flex items-center gap-2"><input type="radio" name="pref_alert" value="strong" required> Tylko silny stres</label>
          </fieldset>
          <fieldset>
            <legend class="mb-1">Sposób prezentacji</legend>
            <label class="flex items-center gap-2"><input type="radio" name="pref_display" value="categories" required> Kategorie (niski / średni / wysoki)</label>
            <label class="flex items-center gap-2"><input type="radio" name="pref_display" value="scale10" required> Skala 1–10</label>
          </fieldset>
          <fieldset>
            <legend class="mb-1">Sugestie relaksacyjne</legend>
            <label class="flex items-center gap-2"><input type="radio" name="pref_relax" value="yes" required> Tak</label>
            <label class="flex items-center gap-2"><input type="radio" name="pref_relax" value="no" required> Nie</label>
            <p class="text-xs opacity-70">(Ćwiczenia dostępne w panelu „Ćwiczenia oddechowe”.)</p>
          </fieldset>
        </section>
      </div>
      <div class="p-4 border-t border-violet-900 flex justify-end gap-2">
        <button id="survey-cancel" type="button" class="px-3 py-1 pill bg-slate-800">Anuluj</button>
        <button id="survey-save" type="button" class="px-3 py-1 pill bg-violet-600">Zapisz</button>
      </div>
    </form>
  </dialog>

  <footer class="max-w-6xl mx-auto px-4 py-6 text-xs opacity-70 text-violet-300">
    Open-source & open-hardware friendly · NeuroBand (ESP32/Max30102/GSR/Temp)
  </footer>

  <script>
    // ------------------ PWA SW + Install ------------------
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/service-worker.js').catch(console.warn); }
    let deferredPrompt = null; const installBtn = document.getElementById('install-btn');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.classList.remove('hidden'); });
    installBtn?.addEventListener('click', async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; installBtn.classList.add('hidden'); }});

    // ------------------ BLE UUIDs ------------------
    const BLE_UUIDS = { service: '0000ffb0-0000-1000-8000-00805f9b34fb', hrChar: '0000ffb1-0000-1000-8000-00805f9b34fb', gsrChar: '0000ffb2-0000-1000-8000-00805f9b34fb', tempChar:'0000ffb3-0000-1000-8000-00805f9b34fb' };

    // ------------------ State ------------------
    const S = {
      connected:false, streaming:false, samples:[],
      history: JSON.parse(localStorage.getItem('ss_history')||'[]'),
      thresholds: { tempHigh: 38, dHR: 12, gsrPct: 0.25, scr: 2 }, // bez SpO₂
      // [1] heart: tablica (wielokrotny wybór)
      profile: JSON.parse(localStorage.getItem('ss_profile')||'{"age":24,"sex":"F","activity_freq":"1-2","heart":[],"hypertension":false,"skin":"none","drug":"none","stress_body":[]}'),
      prefs: JSON.parse(localStorage.getItem('ss_prefs')||'{"alert":"strong","display":"categories","relax":"no"}'),
      vas: { rest: 3, cur: 3 },
      timers:{ mock:null, eval:null }, ble:{ device:null }
    };

    const $ = (id)=>document.getElementById(id);
    const statusDot=$('status-dot'), statusText=$('status-text');
    const errorBanner=$('error-banner');
    const hrValue=$('hr-value'), gsrValue=$('gsr-value'), tempValue=$('temp-value');
    const prefMode=$('pref-mode'), prefAlert=$('pref-alert');
    const siValue=$('si-value'), siCat=$('si-cat');
    const dynDhr=$('dyn-dhr'), dynGsr=$('dyn-gsr'), dynScr=$('dyn-scr');

    // ------------------ Charts ------------------
    const labels=[];
    const chartCfg=(label)=>({ type:'line', data:{ labels, datasets:[{label, data:[], tension:0.3, borderColor:'#7c3aed', pointRadius:0}] }, options:baseOpts() });
    const hrChart=new Chart($('hr-chart'),chartCfg('HR (bpm)'));
    const gsChart=new Chart($('gsr-chart'),chartCfg('GSR (µS)'));
    const tpChart=new Chart($('temp-chart'),chartCfg('Temp (°C)'));
    function baseOpts(){ return { animation:false, plugins:{ legend:{ labels:{ color:'#e2e8f0' } } }, scales:{ x:{ ticks:{ color:'#a78bfa' }, grid:{ color:'rgba(124,58,237,0.2)' } }, y:{ ticks:{ color:'#a78bfa' }, grid:{ color:'rgba(124,58,237,0.2)' } } } } }

    // ------------------ Utils ------------------
    const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
    const median=(arr)=>{ const a=[...arr].sort((x,y)=>x-y); const n=a.length; if(!n) return 0; return n%2? a[(n-1)/2] : 0.5*(a[n/2-1]+a[n/2]); };
    const mean=(arr)=> arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const fmtTime=(t)=>new Date(t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

    function saveHistorySample(sample){
      const key=new Date(sample.t).toISOString().slice(0,10);
      let day=S.history.find(d=>d.date===key); if(!day){ day={date:key,data:[]}; S.history.push(day); }
      day.data.push(sample); localStorage.setItem('ss_history', JSON.stringify(S.history));
    }
    function refreshHistoryUI(){
      const list=$('history-list'); list.innerHTML='';
      const sorted=[...S.history].sort((a,b)=>a.date<b.date?1:-1).slice(0,14);
      for(const d of sorted){
        const avg=(k)=>{ const v=d.data.map(x=>x[k]).filter(n=>typeof n==='number'); if(!v.length) return '–'; const m=Math.round(v.reduce((a,b)=>a+b,0)/v.length); return isNaN(m)?'–':m; };
        const row=document.createElement('div'); row.className='flex items-center justify-between bg-violet-900/20 rounded px-3 py-2';
        row.innerHTML=`<div>${d.date}</div><div class="text-xs opacity-80">HR avg ${avg('hr')} bpm · GSR avg ${avg('gsr')} µS · Temp avg ${avg('temp')} °C</div>`;
        list.appendChild(row);
      }
    }

    // ------------------ Readings table UI ------------------
    function appendReadingRow(s){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="py-1 pr-2 opacity-90">${fmtTime(s.t)}</td>
                    <td class="py-1 pr-2">${(s.hr ?? '–')} ${typeof s.hr==='number'?'bpm':''}</td>
                    <td class="py-1 pr-2">${(typeof s.gsr==='number'? s.gsr.toFixed(2):'–')} ${typeof s.gsr==='number'?'µS':''}</td>
                    <td class="py-1 pr-2">${(typeof s.temp==='number'? s.temp.toFixed(2) : '–')} ${typeof s.temp==='number'?'°C':''}</td>`;
      const tb=$('readings-body'); tb.appendChild(tr);
      while(tb.rows.length>60) tb.deleteRow(0);
    }

    // ------------------ Multipliers ------------------
    function m_HR_age(age){ if(age<=17) return 1.05; if(age<=29) return 1.03; if(age<=49) return 1.00; if(age<=64) return 0.95; return 0.90; }
    function m_GSR_age_sex(age,sex){ if(age<=17) return sex==='F'?1.12:1.14; if(age<=29) return sex==='F'?1.06:1.08; if(age<=49) return sex==='F'?1.00:1.02; if(age<=64) return sex==='F'?0.92:0.94; return sex==='F'?0.86:0.90; }
    function m_HR_fit(freq){ return freq==='0'?1.00: freq==='1-2'?0.98: freq==='3-4'?0.94: 0.90; }
    function m_GSR_fit(freq){ return 1.00; }
    // [1] mapa mnożników dla WIELOKROTNYCH chorób serca
    const HEART_MULTS = { nyha12:1.12, svt:1.08, sinus:1.05, ihd:1.06 };
    function m_HR_heart_multi(arr){
      if(!Array.isArray(arr) || !arr.length) return 1.00;
      // mnożymy, a potem przycinamy sensownie
      let m=1.00;
      for(const k of arr){ m *= (HEART_MULTS[k] ?? 1.00); }
      return clip(m, 1.00, 1.35);
    }
    function m_GSR_skin(v){ return { none:1.00, eczema:1.30, psoriasis:1.25, dry:1.20 }[v] ?? 1.00; }
    function m_drug_hr(v){ return { none:1.00, beta:0.70, anxio:0.95 }[v] ?? 1.00; }
    function m_drug_gsr(v){ return { none:1.00, beta:1.00, anxio:0.95 }[v] ?? 1.00; }
    function clip(x,a,b){ return Math.max(a, Math.min(b, x)); }

    function computeMultipliers(){
      const p=S.profile; const age=Number(p.age||30); const sex=p.sex||'F'; const freq=p.activity_freq||'1-2';
      // kompatybilność wstecz: jeśli ktoś ma zapisany string, zamieniamy na tablicę
      const heartArr = Array.isArray(p.heart) ? p.heart : (p.heart && p.heart!=='none' ? [p.heart] : []);
      let mHR = m_HR_age(age)*m_HR_fit(freq)*m_HR_heart_multi(heartArr)*(p.hypertension?1.05:1.00)*m_drug_hr(p.drug);
      let mGSR= m_GSR_age_sex(age,sex)*m_GSR_fit(freq)*m_GSR_skin(p.skin)*m_drug_gsr(p.drug);
      mHR=clip(mHR,0.70,1.35); mGSR=clip(mGSR,0.70,1.30);
      return { mHR, mGSR };
    }

    // ------------------ Weights ------------------
    function computeWeights(){
      let wHR=0.45, wGSR=0.45, wVAS=0.10; const sb=new Set(S.profile.stress_body||[]);
      if(sb.has('hr')){ wHR+=0.10; wGSR-=0.10; }
      if(sb.has('sweat')){ wGSR+=0.10; wHR-=0.10; }
      if(sb.has('breath')){ wHR+=0.05; }
      if(sb.has('tremor')){ wGSR+=0.05; }
      if(sb.has('focus')){ wVAS+=0.05; }
      const sum=wHR+wGSR+wVAS; wHR/=sum; wGSR/=sum; wVAS/=sum;
      wHR=clip(wHR,0.15,0.70); wGSR=clip(wGSR,0.15,0.70); wVAS=clip(wVAS,0.05,0.40);
      const s2=wHR+wGSR+wVAS; return { wHR:wHR/s2, wGSR:wGSR/s2, wVAS:wVAS/s2 };
    }

    // ------------------ Baselines & SCR ------------------
    function getWindow(arr, secs){ const n=Math.min(arr.length, secs); return arr.slice(-n); }
    function detectSCR(last60){ // piki ≥0.05 µS w ciągu 60 s
      if(last60.length<3) return 0; let count=0; let min=last60[0]; let peak=min; let rising=false;
      for(let i=1;i<last60.length;i++){
        const v=last60[i];
        if(!rising){ if(v-min>=0.05){ rising=true; peak=v; } else { if(v<min) min=v; } }
        else { if(v>peak) peak=v; if(peak - v >= 0.02){ count++; rising=false; min=v; peak=v; } }
      }
      return count;
    }

    // ------------------ [5] Pastelowy baner – aktualizacja ------------------
    function updateStressBanner({ level }) {
      const banner = $('stress-banner');
      const labelEl = $('stress-label');
      const subEl = $('stress-sub');
      const palette = {
        calm:  { bg: 'bg-green-200',  fg: 'text-green-950',  label: 'Spokojnie',    sub: 'Oddychaj miarowo' },
        warn:  { bg: 'bg-yellow-200', fg: 'text-yellow-950', label: 'Podwyższony',  sub: 'Spróbuj ćwiczenia 4–4–4–4' },
        high:  { bg: 'bg-red-200',    fg: 'text-red-950',    label: 'Wysoki',       sub: 'Wykonaj metodę 4–7–8 przez 1–2 min' },
      };
      const p = palette[level] || palette.calm;
      banner.className = `mx-auto max-w-4xl rounded-2xl px-4 py-3 text-center shadow-lg ${p.bg} ${p.fg}`;
      labelEl.textContent = p.label;
      subEl.textContent = p.sub;
    }

    // ------------------ Stress algorithm (co 10 s) ------------------
    function evalStress(){
      const hrSeries=S.samples.map(s=>s.hr), gsrSeries=S.samples.map(s=>s.gsr);
      const hr120=getWindow(hrSeries,120), gsr120=getWindow(gsrSeries,120);
      const HR_baseline=median(hr120), GSR_baseline=median(gsr120);
      const hr10=getWindow(hrSeries,10), gsr10=getWindow(gsrSeries,10), gsr60=getWindow(gsrSeries,60);
      const HR_mean_10s=mean(hr10), GSR_mean_10s=mean(gsr10);
      const SCR_60s=detectSCR(gsr60);

      const { mHR, mGSR }=computeMultipliers();
      const { wHR, wGSR, wVAS }=computeWeights();

      const dHR_thresh=12*mHR; // bpm
      const GSR_level_thresh=(1+0.25*mGSR)*GSR_baseline; // µS
      const SCR_thresh=Math.round(clip(2*mGSR,1,3));
      const VAS_thresh=Math.round(clip(2*(wVAS/0.20),1,4));

      const flag_HR = HR_mean_10s > (HR_baseline + dHR_thresh);
      const flag_GSR = (GSR_mean_10s > GSR_level_thresh) || (SCR_60s >= SCR_thresh);
      const VAS_cur = S.vas.cur, VAS_rest=S.vas.rest; const flag_VAS=(VAS_cur - VAS_rest) >= VAS_thresh;

      const sigma=(x)=> 1/(1+Math.exp(-x));
      const z_HR=(HR_mean_10s - HR_baseline)/12;
      const z_GSR=(GSR_mean_10s - GSR_baseline)/((0.25*GSR_baseline)+0.05);
      const SI = wHR*sigma(z_HR) + wGSR*sigma(z_GSR) + wVAS*clamp((VAS_cur - VAS_rest)/6,0,1);

      const pref=S.prefs.alert; const flags= (flag_HR?1:0)+(flag_GSR?1:0)+(flag_VAS?1:0);
      const alert = (pref==='all') ? (SI>=0.50 || flags>=1) : (SI>=0.70 || flags>=2);

      siValue.textContent=SI.toFixed(2);
      let cat='Niski'; if(SI>=0.70) cat='Wysoki'; else if(SI>=0.50) cat='Średni'; siCat.textContent=cat;

      // ikona w nagłówku
      if(alert){ statusDot.classList.remove('bg-violet-500'); statusDot.classList.add('bg-red-500'); statusText.textContent='Wysoki poziom stresu'; }
      else { statusDot.classList.remove('bg-red-500'); statusDot.classList.add('bg-violet-500'); statusText.textContent='Spokojnie'; }

      // [5] Baner pastelowy – mapujemy kategorię do levelu
      const level = SI>=0.70 ? 'high' : (SI>=0.50 ? 'warn' : 'calm');
      updateStressBanner({ level });

      dynDhr.textContent = Math.round(dHR_thresh);
      const pct = Math.round(25*mGSR); dynGsr.textContent = `+${pct}%`;
      dynScr.textContent = SCR_thresh;
    }

    // ------------------ Streaming ------------------
    function pushSample({hr,gsr,temp}){
      const t=Date.now(); const s={t,hr,gsr,temp};
      S.samples.push(s); if(S.samples.length>600) S.samples.shift();
      saveHistorySample(s); refreshHistoryUI(); appendReadingRow(s);
      hrValue.textContent=(typeof hr==='number'? hr+' bpm':'–');
      gsrValue.textContent=(typeof gsr==='number'? gsr.toFixed(2)+' µS':'–');
      tempValue.textContent=(typeof temp==='number'? temp.toFixed(2)+' °C':'–');

      const time=fmtTime(t); labels.push(time); if(labels.length>600) labels.shift();
      hrChart.data.labels=labels; gsChart.data.labels=labels; tpChart.data.labels=labels;
      hrChart.data.datasets[0].data.push(hr); if(hrChart.data.datasets[0].data.length>600) hrChart.data.datasets[0].data.shift();
      gsChart.data.datasets[0].data.push(gsr); if(gsChart.data.datasets[0].data.length>600) gsChart.data.datasets[0].data.shift();
      tpChart.data.datasets[0].data.push(typeof temp==='number'? temp: null); if(tpChart.data.datasets[0].data.length>600) tpChart.data.datasets[0].data.shift();
      hrChart.update(); gsChart.update(); tpChart.update();
    }

    function startMock(){ if(S.timers.mock) return; S.streaming=true; S.timers.mock=setInterval(()=>{
      const lastHr=(S.samples.at(-1)?.hr)??72; const lastG=(S.samples.at(-1)?.gsr)??5.0;
      const hr=clamp(Math.round(lastHr+(Math.random()*6-3)),55,140);
      const gsr=clamp((lastG + (Math.random()*0.3 - 0.05) + (Math.random()<0.06? 0.12: 0)), 1.0, 20.0); // µS
      const temp=Math.round((36.3 + Math.random()*1.0)*100)/100; // 36.30–37.30°C
      pushSample({hr,gsr,temp});
    },1000); }
    function stopMock(){ if(S.timers.mock){ clearInterval(S.timers.mock); S.timers.mock=null; } S.streaming=false; }

    async function startBLE(){
      errorBanner.classList.add('hidden');
      try{
        const btPermission = await navigator.permissions.query({ name: "bluetooth" });
        if (btPermission.state !== "denied") {
          alert("bu")
           const device=await navigator.bluetooth.requestDevice({ filters:[{ namePrefix:'ESPBT3' }], optionalServices:[BLE_UUIDS.service] });
          S.ble.device=device; const server=await device.gatt.connect(); const service=await server.getPrimaryService(BLE_UUIDS.service);
          const hrChar=await service.getCharacteristic(BLE_UUIDS.hrChar); await hrChar.startNotifications(); hrChar.addEventListener('characteristicvaluechanged', (e)=>{
            const dv=e.target.value; const hr=dv.getUint16(0,true); // tylko HR
            pushSample({ hr, gsr: S.samples.at(-1)?.gsr ?? 5.0, temp: S.samples.at(-1)?.temp });
          });
          const gsrChar=await service.getCharacteristic(BLE_UUIDS.gsrChar); await gsrChar.startNotifications(); gsrChar.addEventListener('characteristicvaluechanged', (e)=>{
            const dv=e.target.value; const gsr=dv.getUint16(0,true)/100; // zakładamy µS*100 w firmware
            pushSample({ hr: S.samples.at(-1)?.hr ?? 70, gsr, temp: S.samples.at(-1)?.temp });
          });
          const tempChar=await service.getCharacteristic(BLE_UUIDS.tempChar); await tempChar.startNotifications(); tempChar.addEventListener('characteristicvaluechanged', (e)=>{
            const dv=e.target.value; const temp=(dv.getUint16(0,true))/100; // °C
            pushSample({ hr: S.samples.at(-1)?.hr ?? 70, gsr: S.samples.at(-1)?.gsr ?? 5.0, temp });
          });
        }
       
        S.connected=true; S.streaming=true;
      }catch(err){ console.warn('BLE error', err); errorBanner.classList.remove('hidden'); }
    }
    function stopBLE(){ try{ S.ble.device?.gatt?.connected && S.ble.device.gatt.disconnect(); }catch{} S.connected=false; }

    function exportCSV(){
      const rows=['timestamp,hr_bpm,gsr_uS,tempC'];
      for(const day of S.history){ for(const x of day.data){ rows.push(`${x.t},${x.hr??''},${typeof x.gsr==='number'? x.gsr.toFixed(3):''},${typeof x.temp==='number'? x.temp:''}`); } }
      const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stresssense_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    // ------------------ Survey wiring ------------------
    const surveyDlg=$('survey-dialog');
    $('open-survey').addEventListener('click', ()=>{ prefillSurvey(); surveyDlg.showModal(); });
    $('survey-x').addEventListener('click', ()=> surveyDlg.close());
    $('survey-cancel').addEventListener('click', ()=> surveyDlg.close());
    surveyDlg.addEventListener('click', (e)=>{ if(e.target===surveyDlg) surveyDlg.close(); });

    function prefillSurvey(){
      const f=$('survey-form');
      f.age.value = S.profile.age||24;
      (f.querySelector(`input[name=sex][value=${S.profile.sex||'F'}]`)||{}).checked = true;
      (f.querySelector(`input[name=activity_freq][value='${S.profile.activity_freq||'1-2'}']`)||{}).checked = true;

      // [1] wielokrotne choroby serca
      const heartArr = Array.isArray(S.profile.heart) ? S.profile.heart : (S.profile.heart && S.profile.heart!=='none' ? [S.profile.heart] : []);
      f.querySelectorAll('input[name="heart"]').forEach(cb => { cb.checked = heartArr.includes(cb.value); });

      (f.querySelector(`input[name=skin][value='${S.profile.skin||'none'}']`)||{}).checked=true;
      (f.querySelector(`input[name=drug][value='${S.profile.drug||'none'}']`)||{}).checked=true;
      const hyp = f.querySelector('input[name=hypertension]'); if(hyp) hyp.checked = !!S.profile.hypertension;
      f.querySelectorAll('input[name="stress_body"]').forEach(ch=> ch.checked = (S.profile.stress_body||[]).includes(ch.value));
      (f.querySelector(`input[name=pref_alert][value='${S.prefs.alert}']`)||{}).checked=true;
      (f.querySelector(`input[name=pref_display][value='${S.prefs.display}']`)||{}).checked=true;
      (f.querySelector(`input[name=pref_relax][value='${S.prefs.relax}']`)||{}).checked=true;
    }

    $('survey-save').addEventListener('click', ()=>{
      const f=$('survey-form'); const form=new FormData(f);
      const selected = (name)=> form.getAll(name);
      S.profile = {
        age:Number(form.get('age')),
        sex:form.get('sex'),
        activity_freq:form.get('activity_freq'),
        // [1] zapisujemy tablicę wielu chorób
        heart:selected('heart'),
        hypertension: !!form.get('hypertension'),
        skin:form.get('skin'),
        drug:form.get('drug'),
        stress_body:selected('stress_body')
      };
      S.prefs = { alert:form.get('pref_alert'), display:form.get('pref_display'), relax:form.get('pref_relax') };
      localStorage.setItem('ss_profile', JSON.stringify(S.profile));
      localStorage.setItem('ss_prefs', JSON.stringify(S.prefs));
      evalStress();
      surveyDlg.close();
    });

    // ------------------ [3] Logika ćwiczeń oddechowych ------------------
    let breathTimer = null;
    function runBreathCycle(phases) {
      clearInterval(breathTimer);
      const ball = $('breath-ball');
      const cue = $('breath-cue');
      let i = 0, tLeft = phases[0].t;
      cue.textContent = phases[0].label;
      applyBallSize(ball, phases[0].size);
      breathTimer = setInterval(() => {
        tLeft -= 1;
        if (tLeft <= 0) {
          i = (i + 1) % phases.length;
          tLeft = phases[i].t;
          cue.textContent = phases[i].label;
          applyBallSize(ball, phases[i].size);
        }
      }, 1000);
    }
    function applyBallSize(el, size) {
      const map = { small: 'w-20 h-20', medium: 'w-28 h-28', large: 'w-40 h-40' };
      el.className = `rounded-full bg-violet-400 transition-all duration-1000 ${map[size]}`;
    }
    function startBoxBreath() {
      runBreathCycle([
        { label: 'Wdech (4s)', t: 4, size: 'large' },
        { label: 'Wstrzymaj (4s)', t: 4, size: 'large' },
        { label: 'Wydech (4s)', t: 4, size: 'small' },
        { label: 'Wstrzymaj (4s)', t: 4, size: 'small' },
      ]);
    }
    function start478() {
      runBreathCycle([
        { label: 'Wdech (4s)', t: 4, size: 'large' },
        { label: 'Wstrzymaj (7s)', t: 7, size: 'large' },
        { label: 'Wydech (8s)', t: 8, size: 'small' },
      ]);
    }
    function stopBreath() {
      clearInterval(breathTimer);
      breathTimer = null;
      $('breath-cue').textContent = 'Kliknij, aby rozpocząć.';
      applyBallSize($('breath-ball'), 'medium');
    }
    function initBreathingUI() {
      $('start-box')?.addEventListener('click', startBoxBreath);
      $('start-478')?.addEventListener('click', start478);
      $('stop-breath')?.addEventListener('click', stopBreath);
    }

    // ------------------ Live controls ------------------
    $('vas-cur').addEventListener('input', (e)=>{ S.vas.cur = Number(e.target.value); });

    $('connect-btn').addEventListener('click', startBLE);
    $('stop-btn').addEventListener('click', ()=>{ stopBLE(); stopMock(); });
    $('demo-btn').addEventListener('click', startMock);
    $('export-btn').addEventListener('click', exportCSV);

    // Init UI
    refreshHistoryUI();
    initBreathingUI(); // [3]
    updateStressBanner({ level: 'calm' }); // [5] inicjalny wygląd
    prefMode.textContent = (S.prefs.display==='scale10') ? 'skala 1–10' : 'kategorie';
    prefAlert.textContent = (S.prefs.alert==='all') ? 'lekki+silny' : 'silny';

    // Run stress algorithm every 10 s
    S.timers.eval = setInterval(evalStress, 10000);
  </script>
</body>
</html>
